name: Build and Release Flutter App

on:
  push:
    tags:
      - 'v*' 

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64, universal]

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      # åˆ‡æ¢ EXCLUDED_ARCHS
      - name: Switch EXCLUDED_ARCHS
        run: |
          PBXPROJ="macos/Runner.xcodeproj/project.pbxproj"
          ARCH=${{ matrix.arch }}
          if [[ "$ARCH" == "universal" ]]; then
            sed -i '' 's/EXCLUDED_ARCHS = .*;/EXCLUDED_ARCHS = "";/g' "$PBXPROJ"
          elif [[ "$ARCH" == "x86_64" ]]; then
            sed -i '' 's/EXCLUDED_ARCHS = .*;/EXCLUDED_ARCHS = "arm64";/g' "$PBXPROJ"
          elif [[ "$ARCH" == "arm64" ]]; then
            sed -i '' 's/EXCLUDED_ARCHS = .*;/EXCLUDED_ARCHS = "x86_64";/g' "$PBXPROJ"
          fi

      # å®‰è£…æ‰“åŒ…å·¥å…·
      - run: dart pub global activate fastforge
      - run: npm install -g appdmg

      # æ‰“åŒ… DMG
      - run: fastforge package --platform macos --targets dmg

      # è·å– Flutter ç‰ˆæœ¬å·
      - name: Get Flutter version
        id: get_version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # é‡å‘½å DMG æ–‡ä»¶ï¼ŒåŠ å…¥æ¶æ„
      - name: Rename DMG with architecture
        run: |
          ARCH=${{ matrix.arch }}
          VERSION=${{ steps.get_version.outputs.version }}
          SRC="dist/$VERSION/lzf_music-$VERSION-macos.dmg"
          DST="dist/$VERSION/LZF-Music-$VERSION-macos-$ARCH.dmg"
          mv "$SRC" "$DST"

      # ä¸Šä¼  macOS åˆ¶å“
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-dmg
          path: dist/${{ steps.get_version.outputs.version }}/LZF-Music-${{ steps.get_version.outputs.version }}-macos-${{ matrix.arch }}.dmg
          retention-days: 1

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      # å®‰è£… Inno Setup 6ï¼ˆfastforge çš„ä¾èµ–ï¼‰
      - name: Install Inno Setup 6
        run: |
          $url = "https://jrsoftware.org/download.php/is.exe"
          $output = "${{ runner.temp }}\innosetup.exe"
          
          Write-Host "Downloading Inno Setup 6..."
          Invoke-WebRequest -Uri $url -OutFile $output
          
          Write-Host "Installing Inno Setup 6..."
          Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
          
          # æ·»åŠ åˆ°PATH
          $innoPath = "C:\Program Files (x86)\Inno Setup 6"
          echo "$innoPath" >> $env:GITHUB_PATH

      - name: Copy Chinese language pack
        run: |
          $sourceFile = "windows\packaging\exe\ChineseSimplified.isl"
          $targetDir = "C:\Program Files (x86)\Inno Setup 6\Languages"
          $targetFile = "$targetDir\ChineseSimplified.isl"
          
          if (Test-Path $sourceFile) {
            Copy-Item $sourceFile $targetFile -Force
            Write-Host "Chinese language pack copied successfully"
          } else {
            Write-Host "Chinese language pack not found in project"
          }

      # å®‰è£… fastforge
      - name: Install fastforge
        run: dart pub global activate fastforge

      # è·å– Flutter ç‰ˆæœ¬å·
      - name: Get Flutter version
        id: get_version
        run: |
          $VERSION = (Get-Content pubspec.yaml | Select-String "version:" | ForEach-Object { $_ -replace "version:\s*", "" } | ForEach-Object { $_ -replace "\+.*", "" })
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT

      # ä½¿ç”¨ fastforge æ‰“åŒ… Windows exe
      - name: Package Windows exe
        run: fastforge package --platform windows --targets exe

      # é‡å‘½åç”Ÿæˆçš„å®‰è£…ç¨‹åº
      - name: Rename Windows installer
        run: |
          $VERSION = "${{ steps.get_version.outputs.version }}"
          
          # fastforge ç”Ÿæˆçš„æ–‡ä»¶é€šå¸¸åœ¨ dist ç›®å½•ä¸­
          $DIST_DIR = "dist\$VERSION"
          $INSTALLER_NAME = "LZF-Music-$VERSION-windows-x64-setup.exe"
          
          # æŸ¥æ‰¾ç”Ÿæˆçš„ exe æ–‡ä»¶
          Get-ChildItem "$DIST_DIR" -Filter "*.exe" | ForEach-Object {
            $SRC = $_.FullName
            Write-Host "Found installer: $SRC"
            Copy-Item $SRC $INSTALLER_NAME -Force
            Write-Host "Renamed to: $INSTALLER_NAME"
          }

      # ä¸Šä¼  Windows åˆ¶å“
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: LZF-Music-${{ steps.get_version.outputs.version }}-windows-x64-setup.exe
          retention-days: 1

  # ç»Ÿä¸€å‘å¸ƒ Release
  create-release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # è·å– Flutter ç‰ˆæœ¬å·
      - name: Get Flutter version
        id: get_version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ä¸‹è½½æ‰€æœ‰åˆ¶å“
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      # åˆ›å»ºç»Ÿä¸€çš„ Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ğŸ‰ å‘å¸ƒç‰ˆæœ¬ ${{ github.ref_name }}  
            ğŸ‰ Release ${{ github.ref_name }}

            ğŸ–¥ï¸ Windows ç‰ˆæœ¬  
            ğŸ–¥ï¸ Windows
              â€¢ å®‰è£…ç¨‹åº: æ”¯æŒ Windows 10/11 (x64)  
                â€¢ Installer: Supports Windows 10/11 (x64)  
              â€¢ åŠŸèƒ½: è‡ªåŠ¨åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼  
                â€¢ Feature: Auto-create desktop shortcut  
              â€¢ æ™ºèƒ½éŸ³é¢‘æ§åˆ¶: æ”¯æŒç³»ç»ŸéŸ³é¢‘æœåŠ¡ï¼Œæ‹”æ‰è€³æœºè‡ªåŠ¨æš‚åœæ’­æ”¾ï¼Œè€³æœºæŒ‰é’®æ§åˆ¶æ’­æ”¾/æš‚åœ/åˆ‡æ­Œ  
                â€¢ Smart Audio Control: integrates with system audio service  
                  - Auto-pause when headphones are unplugged  
                  - Headset buttons for play / pause / next / previous  
              â€¢ âŒ¨ï¸ å¿«æ·é”®æ”¯æŒ  
                â€¢ âŒ¨ï¸ Keyboard Shortcuts  
                - ç©ºæ ¼: æ’­æ”¾ / æš‚åœ  
                  - Space: Play / Pause  
                - Ctrl âŒ˜ + å·¦å³æ–¹å‘é”®: å¿«è¿› / å¿«é€€  
                  - Ctrl âŒ˜ + Left/Right Arrow: Seek backward / forward  
                - Ctrl âŒ˜ + ä¸Šä¸‹æ–¹å‘é”®: åˆ‡æ¢ä¸Šä¸€é¦– / ä¸‹ä¸€é¦–  
                  - Ctrl âŒ˜ + Up/Down Arrow: Previous / Next track  

            ğŸ macOS ç‰ˆæœ¬  
            ğŸ macOS
              â€¢ Intel (x86_64): é€‚ç”¨äº Intel Mac  
                â€¢ Intel (x86_64): for Intel-based Macs  
              â€¢ Apple Silicon (arm64): é€‚ç”¨äº M1/M2 Mac  
                â€¢ Apple Silicon (arm64): for M1/M2 Macs  
              â€¢ é€šç”¨ç‰ˆ (universal): åŒæ—¶æ”¯æŒ Intel å’Œ Apple Silicon  
                â€¢ Universal: supports both Intel & Apple Silicon  
              â€¢ æ™ºèƒ½éŸ³é¢‘æ§åˆ¶: æ‹”æ‰è€³æœºè‡ªåŠ¨æš‚åœï¼Œè€³æœºæŒ‰é’®æ§åˆ¶æ’­æ”¾/æš‚åœ/åˆ‡æ­Œ  
                â€¢ Smart Audio Control: auto-pause when headphones unplugged,  
                  headset buttons for play / pause / next / previous  
              â€¢ âŒ¨ï¸ å¿«æ·é”®æ”¯æŒ  
                â€¢ âŒ¨ï¸ Keyboard Shortcuts  
                - ç©ºæ ¼: æ’­æ”¾ / æš‚åœ  
                  - Space: Play / Pause  
                - Command âŒ˜ + å·¦å³æ–¹å‘é”®: å¿«è¿› / å¿«é€€  
                  - Command âŒ˜ + Left/Right Arrow: Seek backward / forward  
                - Command âŒ˜ + ä¸Šä¸‹æ–¹å‘é”®: åˆ‡æ¢ä¸Šä¸€é¦– / ä¸‹ä¸€é¦–  
                  - Command âŒ˜ + Up/Down Arrow: Previous / Next track  

            âœ¨ æ›´æ–°å†…å®¹  
            âœ¨ What's New
              â€¢ æ”¯æŒæŒ‰ç…§æ·»åŠ æ—¶é—´æ’åº  
                â€¢ Support sorting by added time  
              â€¢ æ”¯æŒæ‰¹é‡é€‰æ‹©åˆ é™¤  
                â€¢ Batch delete support  
              â€¢ ä¼˜åŒ–éŸ³é¢‘æ’­æ”¾ç¨³å®šæ€§ä¸è€³æœºæ§åˆ¶ä½“éªŒ  
                â€¢ Improved audio playback stability & headset control experience  
              â€¢ æ–°å¢æ”¯æŒ M4A ä¸ ALAC æ ¼å¼çš„æ¯”ç‰¹ç‡ä¸é‡‡æ ·ç‡è¯»å–  
                â€¢ Added support for M4A & ALAC bitrate and sample rate parsing  
              â€¢ æ”¯æŒç³»ç»Ÿæ‰˜ç›˜ä¸åå°è¿è¡Œ  
                â€¢ Added system tray integration and background running support  

            ![è€³æœºæ§åˆ¶](https://github.com/GerryDush/LZF-Music/blob/main/doc/images/0.0.12/1.png?raw=true)  
            ![Headset Control](https://github.com/GerryDush/LZF-Music/blob/main/doc/images/0.0.12/2.png?raw=true)
          files: |
            macos-x86_64-dmg/*.dmg
            macos-arm64-dmg/*.dmg
            macos-universal-dmg/*.dmg
            windows-installer/*.exe